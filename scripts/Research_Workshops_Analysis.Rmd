---
title: "Research Workshop Attendance, Marketing, and Satisfaction"
author: "C.M. Curry (STEM Services) and B. Narr (Metrics Coordinator)"
date: '2023-11-14'
output:
  word_document: 
    reference_docx: word_styles.docx
    fig_width: 10
---

```{r setup, include=FALSE}
# FUNCTIONS AND LIBRARIES

knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)    #for plots
library(osfr)       #downloading data from private OSF
library(partykit)   # for decision tree statistical analysis
library(tidyverse)  #for data munging including dates
library(viridis)    #color scheme
library(tm)         #text analysis?
library(SnowballC)  #text analysis
library(wordcloud)  #word clouds

# Load custom function for "other" block
source("ggwordcloud_analysis_complete_ou_colors.R")
# set working directory to be one above the scripts folder.  but is relative to .rmd file??
```

```{r data_osf, include=FALSE}
# Load data from OSF

# Authenticate
# Your OSF PAT should be in .REnviron file following these instructions:
# https://docs.ropensci.org/osfr/reference/osf_auth.html


## Retrieve project
osf_node <- osf_retrieve_node("qjkvf")

## List files in project
osf_files <- osf_ls_files(osf_node)

## Download the files
osf_download(x = osf_files,
             path = NULL, #default save to local working directory
             recurse = TRUE, #download all nested files
             conflicts = "overwrite", #OSF is the canonical version
             progress = TRUE #show progress bar
             )
  
```


```{r data_import_attendance, include=FALSE}

# Analysis requested by JD 2023/08/03
last_two_years_attendance <- read.csv("../raw_data/postworkshop/WorkshopAttendanceJD.csv")

# Preliminary analysis requested by CMC 2023/summer (does not include course-integrated workshops)
workshop <- read.csv ("../raw_data/postworkshop/WorkshopAttendanceUpdate.csv",
                      header=TRUE,
                      stringsAsFactors=FALSE)

```

```{r data_import_marketing_and_feedback, include=FALSE}

# Creating and splitting current levels for marketing
marketing_current_categories <- c("Announcement in Class by Instructor",
                                  "Announcement in Class by Librarian",
                                  "Non-Library Calendar or Newsletter",
                                  "Another Libraries Workshop",
                                  "Walk-in",
                                  "Digital Signage in Non-Library Building",
                                  "Digital Signage in a Library Building",
                                  "Social Media - Other",
                                  "Social Media - Instagram",
                                  "Social Media - Facebook",
                                  "Social Media - Twitter",
                                  "Personal recommendation from OU Librarian",
                                  "Class requirement",
                                  "Departmental/program requirement",
                                  "OU Libraries website",
                                  "Direct Email from OU Librarian to Departmental Listserv",
                                  "Direct Email from OU Libraries Workshop Listserv",
                                  "Direct Email from OU Libraries (Source Unknown)",
                                  "Flyer (Paper or Digital Unspecified)",
                                  "Flyer (Paper or Paper Signage)",
                                  "Supervisor (Forwarded email, word of mouth)",
                                  "Colleagues (Forwarded email, word of mouth)")


# Event registration 
Room339 <- read.csv("../raw_data/preworkshop/Room339_lc_events_20230105043223.csv")
RoomLL123 <- read.csv("../raw_data/preworkshop/LL123_lc_events_20230105043507.csv")
RoomGeneral <- read.csv("../raw_data/preworkshop/General_lc_events_20230105043258.csv")
RoomLearningLabClassroom <- read.csv("../raw_data/preworkshop/LearningLabClassroom_lc_events_20230105043409.csv")

# Merge
Registered <- rbind(Room339,
                    RoomLL123,
                    RoomGeneral,
                    RoomLearningLabClassroom
)

## Convert old categories to equivalent new
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Email from University Libraries"] <- "Direct Email from OU Libraries (Source Unknown)"
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Colleagues"] <- "Colleagues (Forwarded email, word of mouth)"
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Supervisor"] <- "Supervisor (Forwarded email, word of mouth)"
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Department/Program Requirement"] <- "Departmental/program requirement"
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Flyer"] <- "Flyer (Paper or Digital Unspecified)"
Registered$How.did.you.hear.about.this.workshop.[Registered$How.did.you.hear.about.this.workshop.=="Walk-in"] <- "Other (please describe)" #correcting that walk-in should not be a pre-registration option

Registered$ReducedCategories <- Registered$How.did.you.hear.about.this.workshop.
Registered$ReducedCategories[!(Registered$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)] <- "Other (please describe)"
Registered$OtherDescriptions[!(Registered$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)] <- Registered$If.other..please.describe.[!(Registered$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)]


# Post-workshop surveys from libwizard only
## Used for both feedback AND marketing

FeedbackActuallyAttended <- read.csv("../raw_data/postworkshop/report.csv")


## Convert old categories to equivalent new
FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.[FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.=="Email from OU Libraries"] <- "Direct Email from OU Libraries (Source Unknown)"
FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.[FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.=="Colleagues"] <- "Colleagues (Forwarded email, word of mouth)"
FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.[FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.=="Supervisor"] <- "Supervisor (Forwarded email, word of mouth)"
FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.[FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.=="Flyer"] <- "Flyer (Paper or Digital Unspecified)"

FeedbackActuallyAttended$ReducedCategories <- FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.
FeedbackActuallyAttended$ReducedCategories[!(FeedbackActuallyAttended$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)] <- "Other (please describe)"
FeedbackActuallyAttended$OtherDescriptions[!(FeedbackActuallyAttended$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)] <- FeedbackActuallyAttended$How.did.you.hear.about.this.workshop.[!(FeedbackActuallyAttended$How.did.you.hear.about.this.workshop. %in% marketing_current_categories)]
```

```{r, data_import_date_cleaning, include = FALSE}
# Month, day, year, hour, minute, seconds
last_two_years_attendance$Event.Date.and.Time_2 <- mdy_hms(last_two_years_attendance$Event.Date.and.Time,
                                                           truncated = 3)


# separate year, month, date, times
last_two_years_attendance$year <- year(last_two_years_attendance$Event.Date.and.Time_2)
last_two_years_attendance$month <- month(last_two_years_attendance$Event.Date.and.Time_2)
last_two_years_attendance$day <- day(last_two_years_attendance$Event.Date.and.Time_2)
last_two_years_attendance$wday <- wday(last_two_years_attendance$Event.Date.and.Time_2,
                                      week_start = 1, #1 = Monday,
                                      label = TRUE    # days of weeks as characters
                                      )
last_two_years_attendance$hour <-
  format(last_two_years_attendance$Event.Date.and.Time_2, "%H")

last_two_years_attendance$Date <-
  format(last_two_years_attendance$Event.Date.and.Time_2, "%m/%d/%Y")

# convert 00 hour to NA
last_two_years_attendance[last_two_years_attendance$hour=="00", "hour"] <- NA

last_two_years_attendance$hour <- as.numeric(last_two_years_attendance$hour)

```


# Workshop descriptive numbers
We continue to offer more workshops on request (right panel), especially in courses.
```{r workshop_descriptive_stats, echo=FALSE, message = FALSE, warning = FALSE}
ggplot(data = last_two_years_attendance,
       mapping = aes(x = Academic.Year,
                     fill = Is.Course))+
  geom_bar()+
  facet_grid(~Requested.)+
  labs(y = "Number of workshops offered")
```


We have increased the number of topics we've brought "on request" to groups and courses.  The number of distinct topics has declined in the last academic year, likely due to loss of specialist expertise with staff loss.

```{r workshop_descriptive_stats_topics, echo=FALSE, message = FALSE, warning = FALSE}
topics_desc <- last_two_years_attendance %>%
  group_by(Academic.Year,
           Semester,
           Is.Course,
           Requested.
      ) %>%
  summarize(topics_count = n_distinct(Topic))

topics_desc

ggplot(data = topics_desc,
       mapping = aes(x = Academic.Year,
                     y = topics_count,
                     fill = Is.Course))+
  geom_bar(stat = "identity")+
  facet_grid(~Requested.)+
  labs(y = "Number of unique topics offered")

```

LATER TODO: How many instructors and helpers per semester
  - BN gather number of helpers from Libraries collaborators + internal notes and total attendees


# Attendance
## Executive summary


\newpage

## Workshop attendance by format and request

DSI request 2023/07: 
- attendance numbers for each format (below in Figures and analysis)

### Statistical analysis
For scheduled workshops, none of the following variables impact attendance numbers in a conditional inference tree analysis.
- Format (in person vs virtual vs hybrid)
- academic year
- calendar year
- semester (spring, summer, or fall)
- time of day
- workshop topic
- multi-day vs single day scheduling


```{r att_tree, echo=FALSE, message = FALSE, warning = FALSE}
att_tree <- ctree(Total.Attendees ~ 
                    as.factor(Location.of.Outreach) +
                   #as.factor(Requested.) +
                    as.factor(Academic.Year) + 
                    as.factor(Calendar.Year)+
                    as.factor(Topic) + 
                    as.factor(Multiple.Days.)+
                    as.factor(Semester) +
                    #as.factor(Is.Course) +
                    as.factor(Known.three.weeks.advertising) +
                    hour
                  ,
                  data = last_two_years_attendance [
                    #last_two_years_attendance$Known.three.weeks.advertising == "Y" &
                                                      last_two_years_attendance$Is.Course == "N" &
                                                      last_two_years_attendance$Requested. == "N",],
                  control = ctree_control(
                               alpha = 0.05)) #cutoff for splits is p = 0.05 significance

plot(att_tree)
```

When we include whether a workshop was in a course, requested or not, and had a known three-week advertising period or not, only whether a workshop was in a course was still the only deciding factor in increased attendance numbers.



```{r att_tree2, echo=FALSE, message = FALSE, warning = FALSE}
att_tree2 <- ctree(Total.Attendees ~ 
                    as.factor(Location.of.Outreach) +
                    as.factor(Requested.) +
                    as.factor(Academic.Year) + 
                    as.factor(Calendar.Year)+
                    as.factor(Topic) + 
                    as.factor(Multiple.Days.)+
                    as.factor(Semester) +
                    as.factor(Is.Course) +
                    as.factor(Known.three.weeks.advertising)
                  ,
                  data = last_two_years_attendance,
                  control = ctree_control(
                               alpha = 0.05)) #cutoff for splits is p = 0.05 significance

plot(att_tree2)
```




### Figures
Format was not significant, but since it was requested, here is the figure.

```{r attendance_by_format_request, echo=FALSE, message = FALSE, warning = FALSE}
last_two_years_attendance [last_two_years_attendance$Known.three.weeks.advertising == "Y" &
                                                      last_two_years_attendance$Is.Course == "N" &
                                                      last_two_years_attendance$Requested. == "N",]%>%
  ggplot(mapping = aes(x = Location.of.Outreach,
                       y = Total.Attendees,
                       fill = Is.Course))+
  geom_boxplot(notch = TRUE)


```



## Workshop attendance over time
Number of on-request workshops over time: I will be talking with Brianna at our next meeting about pulling and analyzing these numbers.  Scaffolding in some departments may also help with scaling the workload for this, but thatâ€™s at least a year out yet, from what I hear from that committee.  I have added your questions to our analysis list:
- Attendance (y)
- On-requests vs scheduled (fill)
- Calendar year + semester (x) (lump May into spring even if after semester is out - August before school can go into fall)

```{r attendance_over_time, echo=FALSE, message = FALSE, warning = FALSE}
plot_time <- last_two_years_attendance %>% 
  ggplot(mapping = aes(x = as.factor(Calendar.Year),
                       y = Total.Attendees,
                       fill = Requested.)) +
  geom_boxplot(notch = TRUE) +
  labs (y = "People at each workshop")
plot_time


ggplot(data = last_two_years_attendance,
       mapping = aes(x = Academic.Year,
                     y = Total.Attendees,
                     fill = Is.Course))+
  geom_bar(stat = "identity")+
  facet_grid(~Requested., labeller = label_both)+
  labs(y = "Total people reached")

```

## Workshop helper load for on-request workshops over time
DSI request 2023/07: 
- TODO: Libraries personnel to attendance ratios for On Request workshops.  which high-helper topics requested more over time and do we have enough data yet, are those increasing.

# ```{r attendance_over_time, echo=FALSE, message = FALSE, warning = FALSE}
# plot_helpers <- last_two_years_attendance[last_two_years_attendance$Requested.=="Y",] %>%
#   ggplot(mapping = aes(x = as.factor(Calendar.Year),
#                        y = helpers/Total.Attendees,
#                        fill = Topic)) +
#   geom_boxplot(notch = TRUE)
# plot_helpers
# ```


\newpage



## Workshop attendance by topic
- DONE BN: modify to show 
  - scheduled only
  - not on request
  - workshops with =>4 runs (two years)


```{r attendance_by_topic, echo=FALSE, message = FALSE, warning = FALSE}
workshop [workshop$Requested. == "N" &
            workshop$Topic != "African American Newspapers and Primary Sources" &
            workshop$Topic != "Digital newspapers" &
            workshop$Topic != "DMPTool" &
            workshop$Topic != "Intermediate shell" &
            workshop$Topic != "matplotlib" &
            workshop$Topic != "Smoother meetings" &
            workshop$Topic != "Standalone Carpentries R" &
            workshop$Topic != "Standalone Openrefine" &
            workshop$Topic != "Standalone Python" &
            workshop$Topic != "Standalone SQL" &
            workshop$Topic != "Tableau" &
            workshop$Topic != "Troubleshooting" & 
            workshop$Topic != "Using computers",
            ]%>%
  ggplot (aes(x=Topic, y=Total.Attendees, fill=Topic)) +
  geom_boxplot(outlier.shape = NA, notch = TRUE) +
  scale_fill_viridis(discrete = TRUE) +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )+
  geom_jitter(color='black', alpha = 0.55, size = 2, position = position_jitter (width = .1), show.legend = FALSE) +
  ggtitle('Attendees of Scheduled Workshops by Topic')

```



\newpage
## Workshop length vs attendance

### length of session
- Low priority: session length vs attendance

### Single day over multiple sessions vs two-day workshops
```{r carpentries_attendance, echo=FALSE, message = FALSE, warning = FALSE}
#Last one! Plotting attendance for carpentries by multi-day VS single-topic

carpentries <- workshop %>% filter(grepl('Standalone Bash|Standalone Carpentries R|Standalone Git|
                                              Standalone Openrefine|Standalone Python|Standalone SQL|Two-day Carpentries with R|Two-day Carpentries with Python', Topic))

carpentries %>%
  ggplot (aes(x=Topic, y=Total.Attendees, fill=Topic)) +
  geom_boxplot(outlier.shape = NA) +
  scale_fill_viridis(discrete = TRUE) +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )+
  geom_jitter(alpha = 0.55, size = 4, position = position_jitter (width = .08, height = .04), show.legend = FALSE) +
  ggtitle('Multi-Day VS Single Day Workshops')


```


# Workshop feedback

## Executive summary
Tentative results suggest no difference in perception of workshop value by learners among learning formats (in person, hybrid, or online) and generally positive feedback.

## Questions

## Note from BN: I have no idea how the CSV formatting should go in Rmd, so here's what I did in my own editor

```{r postworkshop_data, include=FALSE}
postworkshopsurvey <- read.csv("../raw_data/postworkshop/PostWorkshopSurveyFinal.csv",
         header = TRUE, 
         stringsAsFactors = FALSE)
rows <- as.numeric(count(postworkshopsurvey))

postworkshopsurvey <- na.omit(postworkshopsurvey)

```


```{r, workshop_feedback_date_formats, include = FALSE}
# Month, day, year, hour, minute, seconds
postworkshopsurvey$Date_2 <- mdy_hms(postworkshopsurvey$Date,
                                                           truncated = 3)


# separate year, month, date, times
postworkshopsurvey$year <- year(postworkshopsurvey$Date_2)
postworkshopsurvey$month <- month(postworkshopsurvey$Date_2)
postworkshopsurvey$day <- day(postworkshopsurvey$Date_2)
postworkshopsurvey$wday <- wday(postworkshopsurvey$Date_2,
                                      week_start = 1, #1 = Monday,
                                      label = TRUE    # days of weeks as characters
                                      )

# Overwrite original column with formatted date
postworkshopsurvey$Date <-
  format(postworkshopsurvey$Date_2, "%m/%d/%Y")

```

```{r, workshop_feedback_format_levels, echo = FALSE}

#This will need to be repeated for all three "valuable for" questions, so the levels are ordered in the plots.

postworkshopsurvey$Valuable.for.Program <- factor(x = postworkshopsurvey$Valuable.for.Program,
                                                  levels = c("No answer",
                                                             "Not applicable", 
                                                             "Strongly agree",
                                                             "Agree",
                                                             "Somewhat agree",
                                                             "Neither agree nor disagree",
                                                             "Somewhat disagree",
                                                             "Disagree",
                                                             "Strongly disagree"
                                                             
                                                  ))

```


```{r, workshop_feedback_format_data, echo = FALSE}
joined_post <- left_join(postworkshopsurvey, 
                         last_two_years_attendance,
                         by = c("Date"))

## TODO NEED TO CLEAN TOPICS TO MATCH SURVEYS
# Warning: Detected an unexpected many-to-many relationship between `x` and `y`.
```


## Do you anticipate that this new knowledge can be applied towards your work?
```{r workshop_feedback_newknowledge, echo=FALSE, message = FALSE, warning = FALSE}
postworkshopsurvey %>%
  ggplot(aes(x=Using.New.Knowledge., fill=Using.New.Knowledge.)) +
  geom_bar()+
  scale_fill_viridis_d (aesthetics = "fill") +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )

```


## This workshop was valuable towards your program of study.

### Quantitative 
There was no difference in workshop satisfaction relating to perception of the material as "valuable to my program of study" between workshop formats.
```{r, workshop_feedback_valuableforprogram_stats, include = TRUE}
# summarize into counts

na.post <- joined_post %>%
  filter(!is.na(Location.of.Outreach),
         !is.na(Valuable.for.Program))

# run test for significance
chi_program <- chisq.test(x = na.post$Location.of.Outreach,
           y = na.post$Valuable.for.Program,
           simulate.p.value = TRUE)

workshop_feedback_valuableforprogram_plot <- chi_program$p.value<=0.05
```

```{r, workshop_feedback_valuableforprogram_plot, eval = workshop_feedback_valuableforprogram_plot, include = workshop_feedback_valuableforprogram_plot}
# will only eval or include (ie plot) if test in previous chunk is significant
# count is WRONG summary  here, because we may  have more people in a given category
# proportion of total for row?
# https://r-graphics.org/recipe-bar-graph-proportional-stacked-bar
na.post %>%
  group_by(Location.of.Outreach,
           Valuable.for.Program) %>%
  summarize(count_per_feeling = n()) %>%
ggplot(
       aes(x = Location.of.Outreach,
           y = count_per_feeling,
           fill = Valuable.for.Program)) +
  geom_col(position = "fill")+
    scale_fill_viridis_d (aesthetics = "fill")





```

### Qualitative feedback
```{r workshop_feedback_valuableforprogram, echo=FALSE, message = FALSE, warning = FALSE}
postworkshopsurvey %>%
  mutate(Valuable.for.Program = fct_relevel(Valuable.for.Program, "Strongly agree", "Agree", "Somewhat agree", 
                                            "Neither agree nor disagree", "Somewhat disagree", 
                                            "Strongly disagree", "Not applicable", "No answer")) %>%
  ggplot(aes(x=Valuable.for.Program, fill=Valuable.for.Program)) +
  scale_fill_viridis_d (aesthetics = "fill") +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )

```

## This workshop was valuable towards your career.
```{r workshop_feedback_valuableforcareer, echo=FALSE, message = FALSE, warning = FALSE}
postworkshopsurvey %>%
  mutate(Valuable.for.Career = fct_relevel(Valuable.for.Career, "Strongly agree", "Agree", "Somewhat agree", 
                                           "Neither agree nor disagree", "Somewhat disagree", "Disagree", 
                                           "Strongly disagree", "Not applicable", "No answer")) %>%
  ggplot(aes(x=Valuable.for.Career, fill=Valuable.for.Career)) +
  scale_fill_viridis_d (aesthetics = "fill") +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )
```

## This workshop was valuable towards your teaching.
```{r workshop_feedback_valuableforteaching, echo=FALSE, message = FALSE, warning = FALSE}
postworkshopsurvey %>%
  mutate(Valuable.for.Teaching = fct_relevel(Valuable.for.Teaching, "Strongly agree", "Agree", "Somewhat agree", 
                                             "Neither agree nor disagree", "Somewhat disagree", "Disagree", 
                                             "Strongly disagree", "Not applicable", "No answer")) %>%
  ggplot(aes(x=Valuable.for.Teaching, fill=Valuable.for.Teaching)) +
  scale_fill_viridis_d (aesthetics = "fill") +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )

```

## How do you rate your skills after learning about this workshop topic?
```{r workshop_feedback_valuableforteaching, echo=FALSE, message = FALSE, warning = FALSE}
postworkshopsurvey %>%
  mutate(Rate.Skills = fct_relevel(Rate.Skills, "Need more support and assistance if implementing",
                                   "Can complete a related task independently but not to desired level",
                                   "Can complete a related task independently to desired level",
                                   "Can complete and expand on task, possibly assist others",
                                   "Did not respond")) %>%
  ggplot(aes(x=Rate.Skills, fill=Rate.Skills)) +
  scale_fill_viridis_d (aesthetics = "fill") +
  scale_x_discrete(labels=c("Needs more support", "Independent, but not to desired level", "Independent to desired level", 
                            "Independent, could teach skill", "Did not respond")) +
  theme(panel.background = element_rect(fill = "lightgray",
                                        color = "white",
                                        size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.5, linetype = "solid",
                                        color = "darkgray"),
        panel.grid.minor = element_line(size = 0.25, linetype = "solid",
                                        color = "darkgray"),
        plot.title = element_text(size = 20, hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12, angle = 90, hjust = 0.95, vjust = 0.2)
  )
```

# Wordcloud code

```{r workshop_feedback_liked_code, include=FALSE}
workshopliked <- readLines("C:/Users/Brianna_Narr.ULHKH1JW3/Documents/Documents_narr1655/WorkshopLiked_Cleaned.txt")
likedcorpus <- Corpus(VectorSource(workshopliked))

likedcorpus <- tm_map(likedcorpus, removeNumbers)
likedcorpus <- tm_map(likedcorpus, removeWords, c("liked", "the", "and", "was", "that", "very", 
                                                  "with", "how", "for", "were", "all", "through",
                                                  "you", "have", "like", "more", "but", "had", "could",
                                                  "what", "get", "also", "not", "this", "way",
                                                  "really", "about", "will", "our", "being")) 
likedcorpus <- tm_map(likedcorpus, stripWhitespace)

likeddocmatrix <- TermDocumentMatrix(likedcorpus)
likedmatrix <- as.matrix(likeddocmatrix)
v <- sort(rowSums(likedmatrix), decreasing = TRUE)
likeddf <- data.frame(word = names(v), freq=v)

col <- sapply(seq(0.1, 1, 0.1), function(x) adjustcolor("darkred", x))

```

```{r workshop_feedback_needsimprovement_code, include=FALSE}
workshopimprove<- readLines("C:/Users/Brianna_Narr.ULHKH1JW3/Documents/Documents_narr1655/WorkshopNeedsImprovement_Cleaned.txt")
improvecorpus <- Corpus(VectorSource(workshopimprove))

improvecorpus <- tm_map(improvecorpus, removeNumbers)
improvecorpus <- tm_map(improvecorpus, removeWords, c("the", "and", "was", "that", "very", 
                                                  "with", "how", "for", "were", "all", "through",
                                                  "you", "have", "like", "more", "but", "had", "could",
                                                  "what", "get", "also", "not", "this", "way",
                                                  "really", "about", "will", "our", "being", "would",
                                                  "workshop", "there", "are", "can", "they", "think")) 
improvecorpus <- tm_map(improvecorpus, stripWhitespace)

improvedocmatrix <- TermDocumentMatrix(improvecorpus)
improvematrix <- as.matrix(improvedocmatrix)
v <- sort(rowSums(improvematrix), decreasing = TRUE)
improvedf <- data.frame(word = names(v), freq=v)

col <- sapply(seq(0.1, 1, 0.1), function(x) adjustcolor("darkred", x))
```

```{r workshop_feedback_othertopics_code, include=FALSE}
workshopothertopic <- readLines("C:/Users/Brianna_Narr.ULHKH1JW3/Documents/Documents_narr1655/WorkshopOtherTopics.txt")
othertopiccorpus <- Corpus(VectorSource(workshopothertopic))

othertopiccorpus <- tm_map(othertopiccorpus, content_transformer(tolower))
othertopiccorpus <- tm_map(othertopiccorpus, removeNumbers)
othertopiccorpus <- tm_map(othertopiccorpus, removeWords, stopwords("english"))
othertopiccorpus <- tm_map(othertopiccorpus, removeWords, c("think", "maybe")) 
othertopiccorpus <- tm_map(othertopiccorpus, removePunctuation)
othertopiccorpus <- tm_map(othertopiccorpus, stripWhitespace)

othertopicsdocmatrix <- TermDocumentMatrix(othertopiccorpus)
othertopicsmatrix <- as.matrix(othertopicsdocmatrix)
v3 <- sort(rowSums(othertopicsmatrix), decreasing = TRUE)
othertopicsdf <- data.frame(word = names(v3), freq=v3)
```

```{r workshop_feedback_othercomments_code, include=FALSE}
workshopcomments<- readLines("C:/Users/Brianna_Narr.ULHKH1JW3/Documents/Documents_narr1655/WorkshopOtherComments_Cleaned.txt")
commentscorpus <- Corpus(VectorSource(workshopcomments))

commentscorpus <- tm_map(commentscorpus, removeNumbers)
commentscorpus <- tm_map(commentscorpus, removeWords, c("the", "and", "was", "that", "very", 
                                                  "with", "how", "for", "were", "all", "through",
                                                  "you", "have", "like", "more", "but", "had", "could",
                                                  "what", "get", "also", "not", "this", "way",
                                                  "really", "about", "will", "our", "being", "would",
                                                  "workshop", "there", "are", "can", "they", "think",
                                                  "workshops", "when", "these")) 
commentscorpus <- tm_map(commentscorpus, stripWhitespace)

commentsdocmatrix <- TermDocumentMatrix(commentscorpus)
commentsmatrix <- as.matrix(commentsdocmatrix)
v <- sort(rowSums(commentsmatrix), decreasing = TRUE)
commentsdf <- data.frame(word = names(v), freq=v)

col <- sapply(seq(0.1, 1, 0.1), function(x) adjustcolor("darkred", x))
```

# Name one aspect of the workshop that you liked.
```{r workshop_feedback_liked, echo=FALSE, message = FALSE, warning = FALSE}
wordcloud(words = likeddf$word, freq = likeddf$freq, min.freq = 5,
          max.words = 50, random.order = FALSE,
          random.color = FALSE, colors=col)
```

# Name one aspect of the workshop that could be improved.
```{r workshop_feedback_needsimprovement, echo=FALSE, message = FALSE, warning = FALSE}
wordcloud(words = improvedf$word, freq = improvedf$freq, min.freq = 5,
          max.words = 50, random.order = FALSE,
          random.color = FALSE, colors=col)
```

# What other workshop topics would interest you?
```{r workshop_feedback_otherworkshops, echo=FALSE, message = FALSE, warning = FALSE}
wordcloud(words = othertopicsdf$word, freq = othertopicsdf$freq, min.freq = 5,
          max.words = 50, random.order = FALSE,
          random.color = FALSE, colors=col)
```

# Please let us know any other comments you have about the workshop.
```{r workshop_feedback_othercomments, echo=FALSE, message = FALSE, warning = FALSE}
wordcloud(words = commentsdf$word, freq = commentsdf$freq, min.freq = 5,
          max.words = 50, random.order = FALSE,
          random.color = FALSE, colors=col)
```

### Satisfaction vs format
- DSI request 2023/07:  quality of instruction in each format (online, in person, hybrid, and total) and request/course status.



### Workshop length vs satisfaction
- hours in session
- word cloud relating to length?


# Marketing
## Executive summary
The top three marketing methods that bring in the highest counts of attendees who fill out our post-workshop surveys (hereafter, "attendees" and "attendance") are emails, word-of-mouth, and the OU Libraries website

The marketing methods with the highest response "intensities" (relative proportion of attendees) were class requirements (making liaison outreach to instructors critical), librarians emailing a departmental listserv directly (we have these permissions for at least two STEM departments to my knowledge), and the OU Libraries website.

Thus, our overall most effective marketing methods are emails, the OU Libraries website, word-of-mouth, and outreach to instructors.


\newpage


## Absolute effectiveness (counts of attendees) by marketing method

### Overall counts of attendees by marketing method and registration status
These data for people who filled out a post-workshop survey (ie are confirmed to have attended a workshop) and answer the question "How did you hear about this workshop?".  They are grouped by pre-registered or not pre-registered (passerby walk-ins, class workshops where registration wasn't required).  We do not get 100% completion of surveys.

```{r attendees, echo=FALSE, message = FALSE, warning = FALSE}
marketing_breakdown_initial <- ggplot(data = FeedbackActuallyAttended,
       aes(x = ReducedCategories,
           fill = Did.you.pre.register.for.this.workshop.))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 1,
                                   size = 16),
        axis.text.y = element_text(angle = 0,
                                   hjust = 1,
                                   size = 8),
        panel.background = element_blank(),
        legend.text=element_text(size=16),
        strip.text.y = element_text(size = 16),
        axis.title=element_text(size=16))+
 # facet_grid(type~.)+
  scale_fill_manual(values = c("#8D1732",
                               "#000000"))+
   #                            "#298ac4",
  #                             "#94c893",
   #                            "#cccccc"))+
  coord_flip()+
  labs (y = "Number of participants filling out post-workshop surveys",
        x = "Marketing methods",
        fill = "Pre-registered?")
marketing_breakdown_initial
```


\newpage


### Marketing methods for selection "Other (please describe)" with at least two words

These words suggest that professors, librarians, and previous workshops were included in methods that reached these attendees.  Later data cleaning to incorporate emails/professors/word-of-mouth into the existing categories could be useful.

```{r other, echo = FALSE, message = FALSE, warning = FALSE}


other_source_Preregistered <- ggwordcloud_analysis_complete (df = FeedbackActuallyAttended,
                                                             min_words = 2,
                                                             max_size = 70,
                                                             column = "OtherDescriptions",
                                                             border_margins= 0)

other_source_Preregistered

```



\newpage



## Marketing sources for people who registered for workshops (attendance yet unknown)
These data are from people who filled out the pre-registration form to attend a workshop.  When they filled out this form, we do not know if they will go on to actually attend the workshop.  Most of the people in the previous section will have registered, so there is overlap between the datasets, but the post-workshop surveys are anonymous so we cannot connect them directly.  The next section shows a broad-level view of the relative effectiveness of methods for people who register vs people who follow through and attend.

```{r all_registered, echo = FALSE, message = FALSE, warning = FALSE, include = TRUE}


marketing_breakdown_registration <- ggplot(data = Registered,
       aes(x = ReducedCategories))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 0,
                                   hjust = 1,
                                   size = 16),
        axis.text.y = element_text(angle = 0,
                                   hjust = 1,
                                   size = 8),
        panel.background = element_blank(),
        legend.text=element_text(size=16),
        strip.text.y = element_text(size = 16),
        axis.title=element_text(size=16))+
 # facet_grid(type~.)+
  coord_flip()+
  labs (y = "People pre-registered for the workshops 
        (attendance yet unknown)",
        x = "Marketing methods",
        fill = "")
marketing_breakdown_registration
```

```{r other_registered, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}
## Marketing sources for people who attended the workshop and selected "Other (please describe)"


other_source_registrations <- ggwordcloud_analysis_complete (df = Registered,
                                                             min_words = 2,
                                                             max_size = 16,
                                                             column = "OtherDescriptions")

other_source_registrations

```



\newpage


## Relative effectiveness in marketing methods

We do not get 100% survey responses at our workshops.  However, I wanted to see to see if some marketing methods are proportionately more effective in getting pre-registrants to actually show up at the workshop.  The differences are overall statistically significantly different (Chi-squared = 71.5, df =- 20, p < 0.0001).

Below is a chart that represents this visually as a ratio of attendance to pre-registrant counts.  The vertical beige bar shows approximately where about the same proportion (i.e., 0.5 out of 1, or 50/100) of people who pre-registered (red) ended up actually attending and filling out a survey (black).





```{r effectiveness, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}
# Merge two datasets.
registered_only <- data.frame("DataType" = "pre_registered",
                              "ReducedCategories" = Registered[,"ReducedCategories"])
actually_attended_only <- data.frame("DataType" = "surveyed_attendees",
                              "ReducedCategories" = FeedbackActuallyAttended[,"ReducedCategories"])

# contingency table
all_marketing <- rbind(registered_only,
      actually_attended_only)

# difference in proportions between registered source and attending source?
chisq.test(table(all_marketing))
```

```{r effectiveness_figure, echo = FALSE}

marketing_effectiveness <- ggplot(data = all_marketing,
       aes(x = ReducedCategories,
           fill = DataType))+
  geom_bar(
    position = "fill"
    )+
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5,
                                   size = 16),
        axis.text.y = element_text(angle = 0,
                                   hjust = 1,
                                   size = 8),
        panel.background = element_blank(),
        legend.text=element_text(size=8),
        strip.text.y = element_text(size = 8),
        axis.title=element_text(size=16))+
 # facet_grid(type~.)+
  scale_fill_manual(values = c("#8D1732",
                               "#000000"
                                        ))+
   #                            "#298ac4",
  #                             "#94c893",
   #                            "#cccccc"))+
  coord_flip()+
  labs (y = "Ratio of registration to attendance + survey",
        x = "Marketing methods",
        fill = "Registration vs Attendance")+
  geom_hline(yintercept = 0.5, linewidth = 8, color = "#cccccc")+

  annotate("text", 
           y = 0.5, x = 1, label = "0.5 is equal ratio of registration and attendance", angle = 90, hjust = 0, vjust = 0.5)
marketing_effectiveness

```

A completely red bar indicates that none of the people who completed the pre-registration survey later completed a post-workshop survey.  It is possible some of those attendees showed up but did not complete the offered post-workshop survey.  People who pre-registered and heard about the workshop via Twitter, Facebook, Other Social Media Not Specified, Announcement in Class by Librarian, and paper fliers have this result, suggesting those media may not be resulting in attendees or not resulting in attendees willing to provide feedback.

A completely black bar indicates that pre-registration did not occur but people attended anyways (you see these attendees as the red caps to the black bars in the previous section).  This occurred more with people who attended a workshop given in a class ("Class Requirement"; that category suggests either we visited the class, which does not involve LibCal registration, or that the instructor asked people to attend a workshop outside of class).  With online workshops requiring pre-registration, we don't necessarily expect any bar to be completely black (all walk-ins).  However, in-person workshops can accept passer-by walk-ins who didn't pre-register or people who saw the event via any other marketing method (again, see the previous section's chart) and just showed up without pre-registering. Zoom workshops could have other registrants also forward the Zoom link.

Thus, any method with some black has some attendance, and methods with larger amounts of black indicate relatively stronger responses.  Thus, the highest response "intensity" are for class requirements, librarians emailing a departmental listserv directly (we have these permissions for at least two STEM departments to my knowledge), and people who find events by examining the OU Libraries website.

## Marketing implementation details
### Email detail level and timing

```{r email_code, include=FALSE}
#emails <- read.csv("C:/Users/Brianna_Narr.ULHKH1JW3/Documents/EmailLengthStudyFinal.csv")
emails <- read.csv("../raw_data/preworkshop/EmailLengthStudyFinal.csv")
#Data source: https://osf.io/rvnsh
```

I used registrants instead of confirmed attendees, because that felt more relevant to the emails, and it was more consistently documented. The factors that were considered here were lead time (how much time between the email and the event) and length of email (long = one that was typed by one of you, short = automated libzoom email). Email length was the deciding factor for number of registrants! 

Since the time between registration opening and workshop did not affect attendance.  As such, CMC proposed we open all workshops at the start of the semester.  This change was approved by the committee in slack in Fall 2023 (2023/10/03) to be implemented for the Spring 2024 workshops.  We discussed adding a second reminder for already registered participants, but only one reminder is possible using LibCal automated emails.  We will now post once advertising the full schedule, and then continue doing the 3-weeks-advertising to remind people again.
```{r email_plot, echo=FALSE, message = FALSE, warning = FALSE}
emailtree <- ctree(Total.Registrants ~ 
                    as.factor(From) +
                    as.factor(Long.or.Short) + 
                    Lead.Time..in.days.
                  ,
                  data = emails,
                  control = ctree_control(
                    alpha = 0.05)) #cutoff for splits is p = 0.05 significance
#hist(emails$Lead.Time..in.days.) shows most email lead times are 3 weeks
plot(emailtree)
```


### Registration is a reasonable proxy for attendance
```{r registration_vs_attendance, echo = FALSE, message = FALSE, warning = FALSE}
cor.test()

```